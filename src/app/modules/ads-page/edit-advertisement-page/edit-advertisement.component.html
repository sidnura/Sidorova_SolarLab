<div class="edit-advertisement-container">
  <div class="form-header">
    <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h2>
    <a [routerLink]="['/ad', adId]" class="back-link">‚Üê –ù–∞–∑–∞–¥ –∫ –æ–±—ä—è–≤–ª–µ–Ω–∏—é</a>
  </div>

  @if (isLoading && !advertisement) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏—è...</p>
    </div>
  }

  @if (advertisement) {
    <div class="form-card">
      <form [formGroup]="adForm" (ngSubmit)="onSubmit()" class="ad-form">

        <div class="form-group">
          <label for="name" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
          <input
            id="name"
            type="text"
            formControlName="name"
            placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è"
            class="form-control"
            [class.invalid]="name?.invalid && name?.touched">

          @if (name?.invalid && name?.touched) {
            <div class="validation-errors">
              @if (name?.errors?.['required']) {
                <small>–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ</small>
              }
              @if (name?.errors?.['minlength']) {
                <small>–ú–∏–Ω–∏–º—É–º {{ name?.errors?.['minlength']?.requiredLength }} —Å–∏–º–≤–æ–ª–æ–≤</small>
              }
              @if (name?.errors?.['maxlength']) {
                <small>–ú–∞–∫—Å–∏–º—É–º {{ name?.errors?.['maxlength']?.requiredLength }} —Å–∏–º–≤–æ–ª–æ–≤</small>
              }
            </div>
          }
        </div>

        <div class="form-group">
          <label for="description" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea
            id="description"
            formControlName="description"
            placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ –æ–ø–∏—à–∏—Ç–µ —Ç–æ–≤–∞—Ä –∏–ª–∏ —É—Å–ª—É–≥—É..."
            rows="4"
            class="form-control"
            [class.invalid]="description?.invalid && description?.touched">
          </textarea>

          @if (description?.invalid && description?.touched) {
            <div class="validation-errors">
              @if (description?.errors?.['maxlength']) {
                <small>–ú–∞–∫—Å–∏–º—É–º {{ description?.errors?.['maxlength']?.requiredLength }} —Å–∏–º–≤–æ–ª–æ–≤</small>
              }
            </div>
          }
        </div>

        <div class="form-group">
          <label class="form-label">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</label>

          @if (existingImageUrls.length > 0) {
            <div class="existing-images-section">
              <h4 class="section-subtitle">–¢–µ–∫—É—â–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</h4>
              <div class="image-previews">
                @for (imageUrl of existingImageUrls; track $index; let i = $index) {
                  <div class="image-preview existing">
                    <img
                      [src]="imageUrl"
                      [alt]="'–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ' + (i + 1)"
                      class="preview-img"
                      (error)="onImageError($event, i)">
                    <button type="button" class="remove-image-btn" (click)="removeExistingImage(i)">√ó</button>
                    <span class="image-name">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ {{ i + 1 }}</span>
                  </div>
                }
              </div>
            </div>
          }

          <div class="file-upload-container">
            <input
              type="file"
              id="images"
              (change)="onFileSelected($event)"
              multiple
              accept="image/*"
              class="file-input">
            <label for="images" class="file-upload-label">
              <span class="upload-icon">üì∑</span>
              <span>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</span>
            </label>
          </div>

          @if (selectedFiles.length > 0) {
            <div class="image-previews">
              @for (file of selectedFiles; track $index; let i = $index) {
                <div class="image-preview new">
                  <img
                    [src]="imageUrls[i]"
                    [alt]="file.name"
                    class="preview-img"
                    (error)="onImageError($event, i)">
                  <button type="button" class="remove-image-btn" (click)="removeImage(i)">√ó</button>
                  <span class="image-name">{{ file.name }}</span>
                </div>
              }
            </div>
          }

          <small class="form-text">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π. –£–¥–∞–ª–µ–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –±—É–¥—É—Ç –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ —É–¥–∞–ª–µ–Ω—ã
            –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.</small>
        </div>

        <div class="form-group">
          <label for="cost" class="form-label">–¶–µ–Ω–∞ (‚ÇΩ) *</label>
          <input
            id="cost"
            type="number"
            formControlName="cost"
            placeholder="0"
            min="0"
            step="500"
            class="form-control"
            [class.invalid]="cost?.invalid && cost?.touched">

          @if (cost?.invalid && cost?.touched) {
            <div class="validation-errors">
              @if (cost?.errors?.['required']) {
                <small>–£–∫–∞–∂–∏—Ç–µ —Ü–µ–Ω—É</small>
              }
              @if (cost?.errors?.['min']) {
                <small>–¶–µ–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π</small>
              }
              @if (cost?.errors?.['max']) {
                <small>–°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∞—è —Ü–µ–Ω–∞</small>
              }
            </div>
          }
        </div>

        <div class="form-group">
          <label for="email" class="form-label">Email</label>
          <input
            id="email"
            type="email"
            formControlName="email"
            placeholder="example@mail.com"
            class="form-control"
            [class.invalid]="email?.invalid && email?.touched">

          @if (email?.invalid && email?.touched) {
            <div class="validation-errors">
              @if (email?.errors?.['email']) {
                <small>–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email</small>
              }
            </div>
          }
        </div>

        <div class="form-group">
          <label for="phone" class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω *</label>
          <div class="phone-input-container" [class.invalid]="phone?.invalid && phone?.touched">
            <span class="phone-prefix">+7</span>
            <input
              id="phone"
              type="tel"
              formControlName="phone"
              placeholder="(999) 123-45-67"
              class="form-control phone-input"
              (input)="onPhoneInput($event)"
              (keydown)="onPhoneKeydown($event)"
              maxlength="18">
          </div>

          @if (phone?.invalid && phone?.touched) {
            <div class="validation-errors">
              @if (phone?.errors?.['required']) {
                <small>–¢–µ–ª–µ—Ñ–æ–Ω –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω</small>
              }
              @if (phone?.errors?.['pattern']) {
                <small>–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</small>
              }
              @if (phone?.errors?.['minlength']) {
                <small>–ù–æ–º–µ—Ä —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π</small>
              }
            </div>
          }
        </div>

        <div class="form-group">
          <label for="location" class="form-label">–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ *</label>
          <input
            id="location"
            type="text"
            formControlName="location"
            placeholder="–ì–æ—Ä–æ–¥, –∞–¥—Ä–µ—Å –∏–ª–∏ —Ä–∞–π–æ–Ω"
            class="form-control"
            [class.invalid]="location?.invalid && location?.touched">

          @if (location?.invalid && location?.touched) {
            <div class="validation-errors">
              @if (location?.errors?.['required']) {
                <small>–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ</small>
              }
              @if (location?.errors?.['minlength']) {
                <small>–ú–∏–Ω–∏–º—É–º {{ location?.errors?.['minlength']?.requiredLength }} —Å–∏–º–≤–æ–ª–æ–≤</small>
              }
              @if (location?.errors?.['maxlength']) {
                <small>–ú–∞–∫—Å–∏–º—É–º {{ location?.errors?.['maxlength']?.requiredLength }} —Å–∏–º–≤–æ–ª–æ–≤</small>
              }
            </div>
          }
        </div>

        <div class="form-group">
          <label for="parentCategoryId" class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
          <select
            id="parentCategoryId"
            formControlName="parentCategoryId"
            class="form-control"
            [class.invalid]="parentCategoryId?.invalid && parentCategoryId?.touched">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
            @for (category of parentCategories; track category.id) {
              <option [value]="category.id">{{ category.name }}</option>
            }
          </select>

          @if (parentCategoryId?.invalid && parentCategoryId?.touched) {
            <div class="validation-errors">
              @if (parentCategoryId?.errors?.['required']) {
                <small>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</small>
              }
            </div>
          }
        </div>

        @if (childCategories.length > 0) {
          <div class="form-group">
            <label for="categoryId" class="form-label">–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è</label>
            <select
              id="categoryId"
              formControlName="categoryId"
              class="form-control"
              [class.invalid]="categoryId?.invalid && categoryId?.touched">
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</option>
              @for (category of childCategories; track category.id) {
                <option [value]="category.id">{{ category.name }}</option>
              }
            </select>
          </div>
        }

        @if (selectedParentCategory && childCategories.length === 0) {
          <div class="category-info">
            <small>–ö–∞—Ç–µ–≥–æ—Ä–∏—è –≤—ã–±—Ä–∞–Ω–∞. –ú–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã.</small>
          </div>
        }

        @if (errorMessage) {
          <div class="alert alert-error">
            {{ errorMessage }}
          </div>
        }

        @if (successMessage) {
          <div class="alert alert-success">
            {{ successMessage }}
          </div>
        }

        <div class="form-actions">
          <button
            type="button"
            class="btn btn-secondary"
            (click)="onCancel()">
            –û—Ç–º–µ–Ω–∞
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="adForm.invalid || isLoading">
            @if (isLoading) {
              <span>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...</span>
            } @else {
              <span>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</span>
            }
          </button>
        </div>

      </form>
    </div>
  }
</div>
