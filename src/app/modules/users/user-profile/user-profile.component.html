<div class="user-profile-container">
  <div class="header">
    <h1>{{ isCurrentUser ? 'Мой профиль' : 'Профиль пользователя' }}</h1>
    @if (!isCurrentUser) {
      <button class="btn btn-secondary" routerLink="/users">
        ← Назад к списку
      </button>
    }
  </div>

  <!-- Состояние загрузки -->
  @if (isLoading) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Загрузка профиля...</p>
    </div>
  }

  <!-- Сообщение об ошибке -->
  @if (errorMessage && !isLoading) {
    <div class="alert alert-error">
      {{ errorMessage }}
    </div>
  }

  <!-- Сообщение об успехе -->
  @if (successMessage) {
    <div class="alert alert-success">
      {{ successMessage }}
    </div>
  }

  <!-- Профиль пользователя -->
  @if (user && !isLoading) {
    <div class="profile-content">
      <div class="profile-card">
        @if (isEditing) {
          <!-- Режим редактирования -->
          <form [formGroup]="userForm" (ngSubmit)="onSubmit()">
            <div class="form-group">
              <label for="name" class="form-label">Имя *</label>
              <input
                id="name"
                type="text"
                formControlName="name"
                class="form-control"
                [class.invalid]="name?.invalid && name?.touched">
              @if (name?.invalid && name?.touched) {
                <div class="validation-errors">
                  @if (name?.errors?.['required']) {
                    <small>Имя обязательно</small>
                  }
                  @if (name?.errors?.['minlength']) {
                    <small>Минимум 2 символа</small>
                  }
                </div>
              }
            </div>

            <div class="form-group">
              <label for="login" class="form-label">Логин *</label>
              <input
                id="login"
                type="text"
                formControlName="login"
                class="form-control"
                [class.invalid]="login?.invalid && login?.touched">
              @if (login?.invalid && login?.touched) {
                <div class="validation-errors">
                  @if (login?.errors?.['required']) {
                    <small>Логин обязателен</small>
                  }
                  @if (login?.errors?.['minlength']) {
                    <small>Минимум 3 символа</small>
                  }
                </div>
              }
            </div>

            <div class="form-group">
              <label for="password" class="form-label">Новый пароль</label>
              <input
                id="password"
                type="password"
                formControlName="password"
                class="form-control"
                placeholder="Оставьте пустым, если не хотите менять"
                [class.invalid]="password?.invalid && password?.touched">
              @if (password?.invalid && password?.touched) {
                <div class="validation-errors">
                  @if (password?.errors?.['minlength']) {
                    <small>Минимум 6 символов</small>
                  }
                </div>
              }
            </div>

            @if (password?.value) {
              <div class="form-group">
                <label for="confirmPassword" class="form-label">Подтвердите пароль</label>
                <input
                  id="confirmPassword"
                  type="password"
                  formControlName="confirmPassword"
                  class="form-control"
                  placeholder="Повторите новый пароль"
                  [class.invalid]="confirmPassword?.invalid && confirmPassword?.touched">
                @if (confirmPassword?.invalid && confirmPassword?.touched) {
                  <div class="validation-errors">
                    @if (confirmPassword?.errors?.['passwordMismatch']) {
                      <small>Пароли не совпадают</small>
                    }
                  </div>
                }
              </div>
            }

            <div class="form-actions">
              <button type="button" class="btn btn-secondary" (click)="cancelEditing()">
                Отмена
              </button>
              <button
                type="submit"
                class="btn btn-primary"
                [disabled]="userForm.invalid">
                Сохранить
              </button>
            </div>
          </form>
        } @else {
          <!-- Режим просмотра -->
          <div class="user-info">
            <div class="info-row">
              <span class="label">Имя:</span>
              <span class="value">{{ user.name }}</span>
            </div>
            <div class="info-row">
              <span class="label">Логин:</span>
              <span class="value">{{ user.login }}</span>
            </div>
            <div class="info-row">
              <span class="label">ID:</span>
              <span class="value user-id">{{ user.id }}</span>
            </div>
            @if (user.role) {
              <div class="info-row">
                <span class="label">Роль:</span>
                <span class="value">{{ user.role }}</span>
              </div>
            }
            @if (user.registeredTime) {
              <div class="info-row">
                <span class="label">Зарегистрирован:</span>
                <span class="value">{{ user.registeredTime | date:'dd.MM.yyyy HH:mm' }}</span>
              </div>
            }
          </div>

          @if (isCurrentUser) {
            <div class="profile-actions">
              <button class="btn btn-primary" (click)="startEditing()">
                Редактировать профиль
              </button>
            </div>
          }

          <!-- Список объявлений пользователя -->
          @if (user.adverts && user.adverts.length > 0) {
            <div class="user-adverts">
              <h3>Объявления пользователя ({{ user.adverts.length }})</h3>
              <div class="adverts-list">
                @for (advert of user.adverts; track advert.id) {
                  <div class="advert-item">
                    <div class="advert-info">
                      <h4>{{ advert.name }}</h4>
                      <p class="advert-price">{{ advert.cost | number }} ₽</p>
                      <p class="advert-location">{{ advert.location }}</p>
                      <p class="advert-date">{{ advert.createdAt | date:'dd.MM.yyyy' }}</p>
                      <span class="advert-status" [class.active]="advert.isActive">
                        {{ advert.isActive ? 'Активно' : 'Не активно' }}
                      </span>
                    </div>
                    <button
                      class="btn btn-info"
                      [routerLink]="['/ad', advert.id]">
                      Посмотреть
                    </button>
                  </div>
                }
              </div>
            </div>
          }

          @if (user.adverts && user.adverts.length === 0) {
            <div class="user-adverts">
              <h3>Объявления</h3>
              <p class="no-adverts">Пользователь пока не размещал объявления.</p>
            </div>
          }
        }
      </div>
    </div>
  }
</div>
